#!/bin/bash

# MCP Server Management Script
# Executes MCP servers defined in {{ common_mcp_base_path }}/mcpservers.json

set -euo pipefail

MANIFEST_FILE="{{ common_mcp_base_path }}/mcpservers.json"

usage() {
    echo "Usage: $0 {run|list|info} [server_name] [additional_args...]"
    echo ""
    echo "Commands:"
    echo "  run <server> [args]  - Execute local MCP server"
    echo "  list                 - List all available MCP servers"
    echo "  info <server>        - Show detailed information about a server"
    echo ""
    echo "Examples:"
    echo "  $0 list"
    echo "  $0 info github-mcp-server"
    echo "  $0 run github-mcp-server"
    exit 1
}

check_manifest() {
    if [[ ! -f "$MANIFEST_FILE" ]]; then
        echo "Error: Manifest file not found at $MANIFEST_FILE"
        exit 1
    fi
}

list_servers() {
    check_manifest
    echo "Available MCP servers:"
    jq -r 'keys[]' "$MANIFEST_FILE" | while read -r server; do
        type=$(jq -r ".[\"$server\"].type" "$MANIFEST_FILE")
        if [[ "$type" == "http" ]]; then
            path=$(jq -r ".[\"$server\"].url" "$MANIFEST_FILE")
            echo "  - $server (type: $type, url: $path) [remote]"
        else
            path=$(jq -r ".[\"$server\"].command" "$MANIFEST_FILE")
            echo "  - $server (type: $type, path: $path)"
        fi
    done
}

show_server_info() {
    local server="$1"
    check_manifest

    if ! jq -e ".[\"$server\"]" "$MANIFEST_FILE" >/dev/null 2>&1; then
        echo "Error: Server '$server' not found in manifest"
        echo "Available servers:"
        jq -r 'keys[]' "$MANIFEST_FILE"
        exit 1
    fi

    local type=$(jq -r ".[\"$server\"].type" "$MANIFEST_FILE")

    echo "Server: $server"
    echo "Type: $type"

    if [[ "$type" == "http" ]]; then
        echo "URL: $(jq -r ".[\"$server\"].url" "$MANIFEST_FILE")"
        echo "Location: Remote (hosted service)"
    else
        echo "Command: $(jq -r ".[\"$server\"].command" "$MANIFEST_FILE")"
        echo "Default args: $(jq -r ".[\"$server\"].args | join(\" \")" "$MANIFEST_FILE")"
    fi

    if jq -e ".[\"$server\"].description" "$MANIFEST_FILE" >/dev/null 2>&1; then
        echo "Description: $(jq -r ".[\"$server\"].description" "$MANIFEST_FILE")"
    fi
}

run_server() {
    local server="$1"
    shift # Remove server name, leave additional args

    local type
    local path
    local default_args

    check_manifest

    if ! jq -e ".[\"$server\"]" "$MANIFEST_FILE" >/dev/null 2>&1; then
        echo "Error: Server '$server' not found in manifest"
        echo "Available servers:"
        jq -r 'keys[]' "$MANIFEST_FILE"
        exit 1
    fi

    type=$(jq -r ".[\"$server\"].type" "$MANIFEST_FILE")

    # Handle remote (http) servers
    if [[ "$type" == "http" ]]; then
        echo "Server '$server' is a remote MCP server"
        echo "Type: $type"
        echo "URL: $(jq -r ".[\"$server\"].url" "$MANIFEST_FILE")"
        echo ""
        echo "Remote servers cannot be run locally. They are accessed via HTTP by MCP clients."
        echo "Use the ansible.mcp collection to use this server."
        echo ""
        echo "For more information, run: $0 info $server"
        exit 0
    fi

    # Handle local (stdio) servers
    if [[ "$type" != "stdio" ]]; then
        echo "Error: Server '$server' of type '$type' is not supported for local execution"
        exit 1
    fi

    path=$(jq -r ".[\"$server\"].command" "$MANIFEST_FILE")
    default_args=$(jq -r ".[\"$server\"].args | join(\" \")" "$MANIFEST_FILE")

    echo "Executing MCP server: $server"
    echo "Command: $path $default_args $*"
    echo "Press Ctrl+C to stop"
    echo "----------------------------------------"

    # Execute directly - no background, no PID files, no logs
    # Handle empty args properly - don't pass empty quoted string
    if [[ -n "$default_args" ]]; then
        exec $path $default_args "$@"
    else
        exec $path "$@"
    fi
}

test() {
    local server="$1"
    shift # Remove server name, leave additional args

    local type
    local path
    local default_args

    check_manifest

    if ! jq -e ".[\"$server\"]" "$MANIFEST_FILE" >/dev/null 2>&1; then
        echo "Error: Server '$server' not found in manifest"
        echo "Available servers:"
        jq -r 'keys[]' "$MANIFEST_FILE"
        exit 1
    fi

    type=$(jq -r ".[\"$server\"].type" "$MANIFEST_FILE")

    # Handle remote (http) servers
    if [[ "$type" == "http" ]]; then
        echo "Error: Cannot test remote server '$server' locally"
        echo "Remote servers must be tested through an MCP client configured to connect to:"
        echo "URL: $(jq -r ".[\"$server\"].url" "$MANIFEST_FILE")"
        exit 1
    fi

    # Handle local (stdio) servers
    if [[ "$type" != "stdio" ]]; then
        echo "Error: Server '$server' of type '$type' cannot be tested with this tool"
        exit 1
    fi

    path=$(jq -r ".[\"$server\"].command" "$MANIFEST_FILE")
    default_args=$(jq -r ".[\"$server\"].args | join(\" \")" "$MANIFEST_FILE")

    echo "Testing MCP server: $server"
    echo "Command: $path $default_args $*"
    echo '{"jsonrpc":"2.0","method":"tools/list","id":1}' | $path "$default_args" "$@" | jq '.result.tools[] | {name: .name, description: .description}'
}

# Main script logic
case "${1:-}" in
    run)
        if [[ -z "${2:-}" ]]; then
            echo "Error: Server name required for run command"
            usage
        fi
        run_server "${@:2}"  # Pass server name and any additional args
        ;;
    list)
        list_servers
        ;;
    info)
        if [[ -z "${2:-}" ]]; then
            echo "Error: Server name required for info command"
            usage
        fi
        show_server_info "$2"
        ;;
    test)
        if [[ -z "${2:-}" ]]; then
            echo "Error: Server name required for test command"
            usage
        fi
        test "${@:2}"
        ;;
    *)
        usage
        ;;
esac
