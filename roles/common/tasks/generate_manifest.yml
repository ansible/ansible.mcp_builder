---
# Generate MCP servers manifest

- name: Get registry from parent role
  ansible.builtin.set_fact:
    common_server_registries: "{{ lookup('vars', ansible_parent_role_names[0].split('.')[-1] + '_registry', default=[]) }}"

- name: Assign paths to registry entries
  ansible.builtin.include_tasks: assign_registry_paths.yml

- name: Check if MCP servers manifest exists
  ansible.builtin.stat:
    path: "{{ common_mcp_base_path }}/mcpservers.json"
  register: common_manifest_exists

- name: Read and parse existing manifest
  ansible.builtin.set_fact:
    common_existing_manifest: "{{ lookup('file', common_mcp_base_path + '/mcpservers.json') | from_json }}"
  when: common_manifest_exists.stat.exists

- name: Generate new manifest entries
  ansible.builtin.set_fact:
    common_new_manifest_entries: >-
      {%- set servers = {} -%}
      {%- if common_server_registries is defined and common_server_registries | length > 0 -%}
        {%- for server in common_server_registries -%}
          {%- set server_id = server.name -%}
          {%- set server_data = {
              "type": server.type,
              "args": server.args | default([])
          } -%}
          {%- if server.type == "http" -%}
            {%- set _ = server_data.update({"url": server.path}) -%}
          {%- elif server.type == "stdio" -%}
            {%- set _ = server_data.update({"command": server.path}) -%}
          {%- endif -%}
          {%- if server.description is defined -%}
            {%- set _ = server_data.update({"description": server.description}) -%}
          {%- endif -%}
          {%- set _ = servers.update({server_id: server_data}) -%}
        {%- endfor -%}
      {%- endif -%}
      {{ servers }}

- name: Merge new entries with existing manifest
  ansible.builtin.set_fact:
    common_final_manifest: "{{ (common_existing_manifest | default({})) | combine(common_new_manifest_entries) }}"

- name: Write updated MCP servers manifest
  ansible.builtin.copy:
    content: "{{ common_final_manifest | to_nice_json(indent=4) }}"
    dest: "{{ common_mcp_base_path }}/mcpservers.json"
    mode: "0644"
  become: true
  when: common_new_manifest_entries | length > 0

- name: Ensure MCP server is in the manifest
  ansible.builtin.command:
    cmd: mcp_manage list | grep "{{ common_package_name }}"
  register: common_go_mcp_list_result
  changed_when: false
  when: common_package_name is defined
  failed_when: common_go_mcp_list_result.rc != 0

- name: Display success message
  when:
    - common_package_name is defined
    - common_go_mcp_list_result.rc == 0
    - ansible_verbosity >= 2
  ansible.builtin.debug:
    msg: "MCP server is available. Use 'mcp_manage run {{ common_package_name }}' to run the server manually."
