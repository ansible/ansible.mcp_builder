---
# Shared task: Set up NodeSource repository for Node.js installation
# This is used by both npm_install.yml and npm_setup.yml

- name: Download NodeSource setup script
  ansible.builtin.get_url:
    url: https://rpm.nodesource.com/setup_{{ nodesource_version | default('20') }}.x
    dest: /tmp/nodesource_setup.sh
    mode: "0755"
  become: true

- name: Run NodeSource setup script
  ansible.builtin.command:
    cmd: bash /tmp/nodesource_setup.sh
    creates: /etc/yum.repos.d/nodesource*.repo
  become: true

- name: Refresh dnf cache after adding NodeSource repository
  ansible.builtin.command:
    cmd: dnf makecache
  become: true
  changed_when: false
  failed_when: false

- name: Clean up NodeSource setup script
  ansible.builtin.file:
    path: /tmp/nodesource_setup.sh
    state: absent
  become: true
