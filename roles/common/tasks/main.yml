---
# Common role tasks - Set up generic MCP build environment

# ---------------- Go setup tasks ----------------
- name: Discover all MCP server registries from roles
  ansible.builtin.set_fact:
    discovered_registries: |
      {% set registries = [] %}
      {% for var_name, var_value in hostvars[inventory_hostname].items() %}
        {% if var_name.endswith('_mcp_registry') and var_value is iterable and var_value is not string %}
          {% for server in var_value %}
            {% set _ = registries.append(server) %}
          {% endfor %}
        {% endif %}
      {% endfor %}
      {{ registries }}

- name: Set install flags based on discovered registry entries
  ansible.builtin.set_fact:
    common_install_go: "{{ discovered_registries | selectattr('type', 'equalto', 'go') | list | length > 0 }}"
    common_npm_install: "{{ discovered_registries | selectattr('type', 'equalto', 'npm') | list | length > 0 }}"
    common_pypi_install: "{{ discovered_registries | selectattr('type', 'equalto', 'pypi') | list | length > 0 }}"

- name: Include Go installation tasks
  ansible.builtin.include_tasks: go_install.yml
  when: common_install_go

# ---------------- Node setup tasks ----------------
- name: Include npm installation tasks
  ansible.builtin.include_tasks: npm_install.yml
  when: common_npm_install

# ---------------- PyPI setup tasks ----------------
- name: Include PyPI installation tasks
  ansible.builtin.include_tasks: pypi_install.yml
  when: common_pypi_install

- name: Install jq for JSON processing
  ansible.builtin.package:
    name: jq
    state: present
  become: true

- name: Create unified MCP bin directory
  ansible.builtin.file:
    path: "{{ common_mcp_base_path }}/bin"
    state: directory
    mode: "0755"
  become: true

- name: Generate MCP servers manifest
  ansible.builtin.template:
    src: mcpservers.json.j2
    dest: "{{ common_mcp_base_path }}/mcpservers.json"
    mode: "0644"

- name: Create MCP management script
  ansible.builtin.template:
    src: mcp_manage.j2
    dest: "{{ common_mcp_base_path }}/mcp_manage"
    mode: "0755"

- name: Create symlink for mcp_manage in /usr/local/bin
  ansible.builtin.file:
    src: "{{ common_mcp_base_path }}/mcp_manage"
    dest: /usr/local/bin/mcp_manage
    state: link
    force: true
  become: true

- name: Display MCP servers usage info
  ansible.builtin.debug:
    msg: "MCP servers are available globally via /usr/local/bin/. Manifest: {{ common_mcp_base_path }}/mcpservers.json. Use 'mcp_manage start <server>' to manage servers."
