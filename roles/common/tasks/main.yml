---
# Common role tasks - Set up generic MCP build environment

# ---------------- Go setup tasks ----------------
- name: Discover all MCP server registries from roles
  ansible.builtin.set_fact:
    common_discovered_registries: >-
      {%- set registries = [] -%}
      {%- for var_name in vars.keys() -%}
        {%- if var_name.endswith('_mcp_registry') -%}
          {%- set var_value = vars[var_name] -%}
          {%- if var_value is iterable and var_value is not string -%}
            {%- for server in var_value -%}
              {%- if server is mapping and server.name is defined and server.type is defined -%}
                {%- set _ = registries.append(server) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {{ registries }}

- name: Set install flags based on discovered registry entries
  ansible.builtin.set_fact:
    common_install_go: "{{ common_go_servers_found | length > 0 }}"
    common_npm_install: "{{ common_npm_servers_found | length > 0 }}"
    common_pypi_install: "{{ common_pypi_servers_found | length > 0 }}"
  vars:
    common_go_servers_found: "{{ common_discovered_registries | selectattr('lang', 'equalto', 'go') | list }}"
    common_npm_servers_found: "{{ common_discovered_registries | selectattr('lang', 'equalto', 'npm') | list }}"
    common_pypi_servers_found: "{{ common_discovered_registries | selectattr('lang', 'equalto', 'pypi') | list }}"

- name: Include Go installation tasks
  ansible.builtin.include_tasks: go_install.yml
  when: common_install_go

# ---------------- Node setup tasks ----------------
- name: Include npm installation tasks
  ansible.builtin.include_tasks: npm_install.yml
  when: common_npm_install

# ---------------- PyPI setup tasks ----------------
- name: Include PyPI installation tasks
  ansible.builtin.include_tasks: pypi_install.yml
  when: common_pypi_install

- name: Install jq for JSON processing
  ansible.builtin.package:
    name: jq
    state: present
  become: true

- name: Create unified MCP bin directory
  ansible.builtin.file:
    path: "{{ common_mcp_base_path }}/bin"
    state: directory
    mode: "0755"
  become: true

- name: Generate MCP management script
  ansible.builtin.include_tasks: generate_management.yml

- name: Create symlink for mcp_manage in system bin directory
  ansible.builtin.file:
    src: "{{ common_mcp_base_path }}/mcp_manage"
    dest: "{{ common_system_bin_path }}/mcp_manage"
    state: link
    force: true
  become: true

- name: Assign paths to all MCP servers (centralized)
  ansible.builtin.include_tasks: assign_registry_paths.yml

- name: Generate MCP servers manifest
  ansible.builtin.include_tasks: generate_manifest.yml

- name: Create symlinks for Go binaries in system bin directory
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ common_go_binary_dest_path }}"
    state: link
    force: true
  become: true
  vars:
    common_go_binary_dest_path: "{{ common_system_bin_path }}/{{ item.name }}"
    common_go_servers: "{{ common_discovered_registries | selectattr('type', 'equalto', 'go') | list }}"
  loop: "{{ common_go_servers }}"
  when: common_go_servers | length > 0

- name: Create wrapper scripts for npm servers in system bin directory
  ansible.builtin.template:
    src: mcp_wrapper.j2
    dest: "{{ common_npm_wrapper_dest_path }}"
    mode: "0755"
  become: true
  vars:
    common_npm_wrapper_dest_path: "{{ common_system_bin_path }}/{{ item.name }}"
    common_npm_servers: "{{ common_discovered_registries | selectattr('type', 'equalto', 'npm') | list }}"
    common_server_name: "{{ item.name }}"
    common_server_type: "{{ item.type }}"
  loop: "{{ common_npm_servers }}"
  when: common_npm_servers | length > 0

- name: Create wrapper scripts for pypi servers in system bin directory
  ansible.builtin.template:
    src: mcp_wrapper.j2
    dest: "{{ common_pypi_wrapper_dest_path }}"
    mode: "0755"
  become: true
  vars:
    common_pypi_wrapper_dest_path: "{{ common_system_bin_path }}/{{ item.name }}"
    common_pypi_servers: "{{ common_discovered_registries | selectattr('type', 'equalto', 'pypi') | list }}"
    common_server_name: "{{ item.name }}"
    common_server_type: "{{ item.type }}"
  loop: "{{ common_pypi_servers }}"
  when: common_pypi_servers | length > 0

- name: Display MCP servers usage info
  ansible.builtin.debug:
    msg: "MCP servers are available globally by name (e.g., 'github-mcp-server', 'mcp-hello-world') and via 'mcp_manage run <server>'."
