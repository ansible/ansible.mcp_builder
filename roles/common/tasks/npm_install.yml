---
# Node.js and npm installation tasks

- name: Install Node.js and npm via system package manager
  ansible.builtin.package:
    name:
      - nodejs
      - npm
    state: present
  become: true

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: common_node_version_output
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Installed Node.js version: {{ common_node_version_output.stdout }}"
  when: common_node_version_output is defined

- name: Verify NPM installation
  ansible.builtin.command: npm --version
  register: common_npm_version_output
  changed_when: false

- name: Display NPM version
  ansible.builtin.debug:
    msg: "Installed NPM version: {{ common_npm_version_output.stdout }}"
  when: common_npm_version_output is defined

- name: Get npm servers from discovered registries
  ansible.builtin.set_fact:
    common_npm_servers: "{{ common_discovered_registries | selectattr('type', 'equalto', 'npm') | list }}"

- name: Create MCP servers directory
  ansible.builtin.file:
    path: "{{ common_mcp_base_path }}/npm_installs"
    state: directory
    mode: "0755"
  when: common_npm_servers | length > 0

- name: Initialize package.json for MCP servers
  ansible.builtin.shell: |
    set -o pipefail
    cd {{ common_mcp_base_path }}/npm_installs
    if [ ! -f package.json ]; then
      npm init -y
    fi
  args:
    executable: /bin/bash
    creates: "{{ common_mcp_base_path }}/npm_installs/package.json"
  when: common_npm_servers | length > 0
  changed_when: true

- name: Install MCP servers via npm
  ansible.builtin.shell: |
    set -o pipefail
    cd {{ common_mcp_base_path }}/npm_installs
    npm install {{ item.name }}
  args:
    executable: /bin/bash
  loop: "{{ common_npm_servers }}"
  when: common_npm_servers | length > 0
  register: common_mcp_install_result
  failed_when: false
  changed_when: common_mcp_install_result.rc == 0

- name: Verify MCP servers are callable
  ansible.builtin.shell: |
    set -o pipefail
    npx --prefix {{ common_mcp_base_path }}/npm_installs {{ item.name }} --help || echo "FAILED: {{ item.name }}"
  args:
    executable: /bin/bash
  loop: "{{ common_npm_servers }}"
  when: common_npm_servers | length > 0
  register: common_mcp_verify_result
  failed_when: false
  changed_when: false

- name: Display MCP server verification results
  ansible.builtin.debug:
    msg: "{{ 'MCP server working' if item.rc == 0 else 'MCP server failed' }}: {{ item.item.name }}"
  loop: "{{ common_mcp_verify_result.results | default([]) }}"
  when: common_npm_servers | length > 0
