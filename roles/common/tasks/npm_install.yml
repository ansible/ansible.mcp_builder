---
# Node.js and npm installation tasks

- name: Check if Node.js {{ common_nodejs_min_version }}+ is already installed
  ansible.builtin.shell: |
    if command -v node >/dev/null 2>&1; then
      node_version=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
      if [ "$node_version" -ge {{ common_nodejs_min_version }} ]; then
        echo "sufficient"
      else
        echo "insufficient"
      fi
    else
      echo "not_installed"
    fi
  register: common_node_check
  changed_when: false

- name: Install Node.js {{ common_nodejs_min_version }} from NodeSource
  block:
    - name: Download NodeSource setup script
      ansible.builtin.get_url:
        url: https://rpm.nodesource.com/setup_{{ common_nodejs_min_version }}.x
        dest: /tmp/nodesource_setup.sh
        mode: '0755'
      become: true

    - name: Run NodeSource setup script
      ansible.builtin.command:
        cmd: bash /tmp/nodesource_setup.sh
      become: true
      changed_when: true

    - name: Install Node.js {{ common_nodejs_min_version }}
      ansible.builtin.package:
        name: nodejs
        state: present
      become: true

    - name: Clean up NodeSource setup script
      ansible.builtin.file:
        path: /tmp/nodesource_setup.sh
        state: absent
      become: true
  when: common_node_check.stdout != "sufficient"

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: common_node_version_output
  changed_when: false

- name: Assert Node.js is working
  ansible.builtin.assert:
    that:
      - common_node_version_output.rc == 0
      - common_node_version_output.stdout is defined
      - common_node_version_output.stdout != ""
    fail_msg: "Node.js installation verification failed - command 'node --version' did not work"
    success_msg: "Node.js {{ common_node_version_output.stdout }} verified successfully"

- name: Verify NPM installation
  ansible.builtin.command: npm --version
  register: common_npm_version_output
  changed_when: false

- name: Assert NPM is working
  ansible.builtin.assert:
    that:
      - common_npm_version_output.rc == 0
      - common_npm_version_output.stdout is defined
      - common_npm_version_output.stdout != ""
    fail_msg: "NPM installation verification failed - command 'npm --version' did not work"
    success_msg: "NPM {{ common_npm_version_output.stdout }} verified successfully"

- name: Create MCP servers directory
  ansible.builtin.file:
    path: "{{ common_mcp_base_path }}/npm_installs"
    state: directory
    mode: "0755"

- name: Initialize package.json for MCP servers
  ansible.builtin.command:
    cmd: npm init -y
    chdir: "{{ common_mcp_base_path }}/npm_installs"
    creates: "{{ common_mcp_base_path }}/npm_installs/package.json"

- name: Check if npm package is already installed
  ansible.builtin.stat:
    path: "{{ common_mcp_base_path }}/npm_installs/node_modules/{{ common_package_name }}"
  register: common_npm_package_check

- name: Install npm package
  ansible.builtin.command:
    cmd: npm install {{ common_package_name }}
    chdir: "{{ common_mcp_base_path }}/npm_installs"
  register: common_npm_install_result
  failed_when: false
  changed_when: common_npm_install_result.rc == 0
  when:
    - not common_npm_package_check.stat.exists

- name: Display successfully installed npm package
  ansible.builtin.debug:
    msg: "Successfully installed npm MCP package: {{ common_package_name }}"
  when:
    - common_npm_install_result is defined
    - common_npm_install_result.rc == 0
    - ansible_verbosity >= 2

- name: Display failed npm package installation
  ansible.builtin.debug:
    msg: "Failed to install npm package: {{ common_package_name }}"
  when:
    - common_npm_install_result is defined
    - common_npm_install_result.rc != 0

- name: Access npm package
  ansible.builtin.command:
    cmd: npx --prefix {{ common_mcp_base_path }}/npm_installs {{ common_package_name }} --help
  register: common_npm_verify_result
  changed_when: false
  failed_when: false

- name: Display successful npm package access message
  ansible.builtin.debug:
    msg: "Successfully accessed npm package via npx: {{ common_package_name }}"
  when:
    - common_npm_verify_result is defined
    - common_npm_verify_result.rc == 0
    - ansible_verbosity >= 2

- name: Display failed npm package access message
  ansible.builtin.debug:
    msg: "Failed to access npm package via npx: {{ common_package_name }}"
  when:
    - common_npm_verify_result is defined
    - common_npm_verify_result.rc != 0

# Clean up

- name: Clean npm cache (created during package install)
  ansible.builtin.command: npm cache clean --force
  failed_when: false
  changed_when: false
