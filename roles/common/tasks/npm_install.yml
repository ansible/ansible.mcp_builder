---
# Node.js and npm installation tasks

- name: Include npm setup tasks
  ansible.builtin.include_tasks: npm_setup.yml
  when: not common_npm_installed

- name: Create MCP servers directory
  ansible.builtin.file:
    path: "{{ common_mcp_base_path }}/npm_installs"
    state: directory
    mode: "0755"

- name: Initialize package.json for MCP servers
  ansible.builtin.command:
    cmd: npm init -y
    chdir: "{{ common_mcp_base_path }}/npm_installs"
    creates: "{{ common_mcp_base_path }}/npm_installs/package.json"

- name: Check if npm package is already installed
  ansible.builtin.stat:
    path: "{{ common_mcp_base_path }}/npm_installs/node_modules/{{ common_package_name }}"
  register: common_npm_package_check

- name: Install npm package
  ansible.builtin.command:
    cmd: npm install {{ common_package_name }}
    chdir: "{{ common_mcp_base_path }}/npm_installs"
  register: common_npm_install_result
  failed_when: false
  changed_when: common_npm_install_result.rc == 0
  when:
    - not common_npm_package_check.stat.exists

- name: Display successfully installed npm package
  ansible.builtin.debug:
    msg: "Successfully installed npm MCP package: {{ common_package_name }}"
  when:
    - common_npm_install_result is defined
    - common_npm_install_result.rc == 0
    - ansible_verbosity >= 2

- name: Display failed npm package installation
  ansible.builtin.debug:
    msg: "Failed to install npm package: {{ common_package_name }}"
  when:
    - common_npm_install_result is defined
    - common_npm_install_result.rc != 0

- name: Access npm package
  ansible.builtin.command:
    cmd: npx --prefix {{ common_mcp_base_path }}/npm_installs {{ common_package_name }} --help
  register: common_npm_verify_result
  changed_when: false
  failed_when: false

- name: Display successful npm package access message
  ansible.builtin.debug:
    msg: "Successfully accessed npm package via npx: {{ common_package_name }}"
  when:
    - common_npm_verify_result is defined
    - common_npm_verify_result.rc == 0
    - ansible_verbosity >= 2

- name: Display failed npm package access message
  ansible.builtin.debug:
    msg: "Failed to access npm package via npx: {{ common_package_name }}"
  when:
    - common_npm_verify_result is defined
    - common_npm_verify_result.rc != 0

# Clean up
- name: Clean npm cache (created during package install)
  ansible.builtin.command: npm cache clean --force
  failed_when: false
  changed_when: false
