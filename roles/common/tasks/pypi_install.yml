---
# PyPI & uv installation tasks

- name: Include pypi setup tasks
  ansible.builtin.include_tasks: pypi_setup.yml
  when:
    - not common_pypi_installed

- name: Install PyPI MCP server package
  ansible.builtin.command:
    cmd: uv tool install {{ common_package_name }}
  register: common_pypi_install_result
  failed_when: false
  changed_when: common_pypi_install_result.rc == 0

- name: Display successfully installed PyPI package
  ansible.builtin.debug:
    msg: "Successfully installed PyPI MCP server package: {{ common_package_name }}"
  when:
    - common_pypi_install_result is defined
    - common_pypi_install_result.rc == 0
    - ansible_verbosity >= 2

- name: Display failed PyPI package installation
  ansible.builtin.debug:
    msg: "Failed to install PyPI package: {{ common_package_name }}"
  when:
    - common_pypi_install_result is defined
    - common_pypi_install_result.rc != 0
    - ansible_verbosity >= 2

- name: Verify PyPI package is working
  ansible.builtin.command:
    cmd: uvx {{ common_package_name }} --help
  register: common_pypi_verify_result
  changed_when: false

- name: Display successful PyPI package access message
  ansible.builtin.debug:
    msg: "Successfully accessed PyPI package via uvx: {{ common_package_name }}"
  when:
    - common_pypi_verify_result is defined
    - common_pypi_verify_result.rc == 0
    - ansible_verbosity >= 2

- name: Display failed PyPI package access message
  ansible.builtin.debug:
    msg: "Failed to access PyPI package via uvx: {{ common_package_name }}"
  when:
    - common_pypi_verify_result is defined
    - common_pypi_verify_result.rc != 0

# Clean up

- name: Clean uv cache (created during installation)
  ansible.builtin.file:
    path: "{{ lookup('env', 'HOME') }}/.cache/uv"
    state: absent
