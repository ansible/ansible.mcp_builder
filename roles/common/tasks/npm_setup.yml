---
# Node.js and npm setup tasks
# Note: UBI9 doesn't have nodejs in default repos, so we need to set up NodeSource repo first
- name: Set up NodeSource repository
  ansible.builtin.include_tasks: nodesource_setup.yml
  vars:
    nodesource_version: "{{ common_nodejs_min_version | default(20) }}"

- name: Install Node.js and npm via system package manager
  ansible.builtin.package:
    name: nodejs
    state: present
  become: true

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: common_node_version_output
  changed_when: false

- name: Assert Node.js is working
  ansible.builtin.assert:
    that:
      - common_node_version_output.rc == 0
      - common_node_version_output.stdout is defined
      - common_node_version_output.stdout != ""
    fail_msg: "Node.js installation verification failed - command 'node --version' did not work"
    success_msg: "Node.js {{ common_node_version_output.stdout }} verified successfully"

- name: Verify NPM installation
  ansible.builtin.command: npm --version
  register: common_npm_version_output
  changed_when: false

- name: Assert NPM is working
  ansible.builtin.assert:
    that:
      - common_npm_version_output.rc == 0
      - common_npm_version_output.stdout is defined
      - common_npm_version_output.stdout != ""
    fail_msg: "NPM installation verification failed - command 'npm --version' did not work"
    success_msg: "NPM {{ common_npm_version_output.stdout }} verified successfully"

- name: Mark npm as installed
  ansible.builtin.set_fact:
    common_npm_installed: true
