[ansible]

[testenv]
# Use system site-packages so tox can access molecule-plugins[podman]
# installed in the container
sitepackages = True
deps =
    molecule-plugins[podman]
    ansible-core>=2.14
# Allow ansible-galaxy, bash, and sh to run
allowlist_externals =
    ansible-galaxy
    bash
    sh
# Set ANSIBLE_COLLECTIONS_PATH to include both tox path and default path
# This ensures driver playbooks (like podman create) can find collections
# Note: {envname} is the tox environment name (e.g., integration-py3.10-2.17)
setenv =
    ANSIBLE_COLLECTIONS_PATH = .tox/{envname}/tmp/collections:{env:HOME}/.ansible/collections
# Build and install the local collection so Molecule can find ansible.mcp_builder.common
# Also install containers.podman for the podman driver's create playbook
# Install to BOTH paths:
# 1. Tox environment's collections path (where Molecule looks) - find it dynamically
# 2. ~/.ansible/collections (default Ansible path for driver playbooks)
commands_pre =
    sh -c "cd {toxinidir} && ansible-galaxy collection build --output-path /tmp && COLLECTION_TAR=$(ls -t /tmp/ansible-mcp_builder-*.tar.gz 2>/dev/null | head -1) && [ -n \"$COLLECTION_TAR\" ] && TOX_COLLECTIONS_PATH=$(python3 -c \"import os, glob; paths = glob.glob('.tox/integration-*/tmp/collections'); print(paths[0] if paths else '.tox/integration-py3.10-2.17/tmp/collections')\") && mkdir -p \"$TOX_COLLECTIONS_PATH\" && DRIVER_PLAYBOOK_DIR=$(python3 -c \"import molecule_plugins; import os; plugin_path = os.path.dirname(molecule_plugins.__file__); playbook_path = os.path.join(plugin_path, 'podman', 'playbooks'); print(playbook_path if os.path.exists(os.path.join(playbook_path, 'create.yml')) else '')\" 2>/dev/null || echo '') && if [ -n \"$DRIVER_PLAYBOOK_DIR\" ] && [ -d \"$DRIVER_PLAYBOOK_DIR\" ]; then DRIVER_COLLECTIONS_DIR=\"$DRIVER_PLAYBOOK_DIR/collections\" && mkdir -p \"$DRIVER_COLLECTIONS_DIR\" && ansible-galaxy collection install containers.podman ansible.posix --force --collections-path \"$DRIVER_COLLECTIONS_DIR\"; fi && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path \"$TOX_COLLECTIONS_PATH\" && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path ~/.ansible/collections && ansible-galaxy collection install containers.podman ansible.posix --force --collections-path \"$TOX_COLLECTIONS_PATH\" && ansible-galaxy collection install containers.podman ansible.posix --force --collections-path ~/.ansible/collections"
