[ansible]

[testenv]
# Use system site-packages to access molecule-plugins[podman] installed in container
sitepackages = True

deps =
    ansible-core>=2.14
    molecule-plugins[podman]

allowlist_externals =
    ansible-galaxy
    bash
    sh
    mkdir
    ls

setenv =
    ANSIBLE_COLLECTIONS_PATH = {env:HOME}/.ansible/collections
    MOLECULE_IMAGE = {env:MOLECULE_IMAGE:ghcr.io/ansible/mcp-builder-test-base:latest}

commands_pre =
    # 1. Build the collection tarball
    bash -c "cd {toxinidir} && ansible-galaxy collection build --force --output-path {envtmpdir}"

    # 2. Create collection directory
    mkdir -p {env:HOME}/.ansible/collections

    # 3. Install our collection to default Ansible path
    bash -c "COLLECTION_TAR=$(ls -t {envtmpdir}/ansible-mcp_builder-*.tar.gz | head -1) && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path {env:HOME}/.ansible/collections"

    # 4. Install dependencies to default path (for Molecule driver playbooks and test playbooks)
    ansible-galaxy collection install containers.podman ansible.posix --force --collections-path {env:HOME}/.ansible/collections
