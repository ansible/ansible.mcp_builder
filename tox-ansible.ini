[ansible]

[testenv]
# Use system site-packages to access molecule-plugins[podman] installed in container
sitepackages = True

deps =
    ansible-core>=2.18
    molecule-plugins[podman]

allowlist_externals =
    ansible-galaxy
    bash
    sh
    mkdir
    ls

setenv =
    ANSIBLE_COLLECTIONS_PATH = {envtmpdir}/collections:{env:HOME}/.ansible/collections
    MOLECULE_IMAGE = {env:MOLECULE_IMAGE:ghcr.io/ansible/mcp-builder-test-base:latest}

commands_pre =
    # Build collection tarball
    bash -c "cd {toxinidir} && ansible-galaxy collection build --force --output-path {envtmpdir}"

    # Create collection directories
    mkdir -p {envtmpdir}/collections
    mkdir -p {env:HOME}/.ansible/collections

    # Install collection to tox environment path (used by sanity tests)
    bash -c "COLLECTION_TAR=$(ls -t {envtmpdir}/ansible-mcp_builder-*.tar.gz | head -1) && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path {envtmpdir}/collections"

    # Install collection to default Ansible path (used by Molecule integration tests)
    bash -c "COLLECTION_TAR=$(ls -t {envtmpdir}/ansible-mcp_builder-*.tar.gz | head -1) && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path {env:HOME}/.ansible/collections"

    # Install dependencies to both paths
    ansible-galaxy collection install containers.podman ansible.posix --force --collections-path {envtmpdir}/collections
    ansible-galaxy collection install containers.podman ansible.posix --force --collections-path {env:HOME}/.ansible/collections

[testenv:sanity]
# Sanity tests use default tox-ansible behavior (runs from {envtmpdir}/collections)
