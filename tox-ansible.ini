[ansible]

[testenv]
# Use system site-packages to access molecule-plugins[podman] installed in container
sitepackages = True

deps =
    ansible-core>=2.14
    molecule-plugins[podman]

allowlist_externals =
    ansible-galaxy
    bash
    sh
    mkdir
    ls

setenv =
    ANSIBLE_COLLECTIONS_PATH = {env:HOME}/.ansible/collections
    MOLECULE_IMAGE = {env:MOLECULE_IMAGE:ghcr.io/ansible/mcp-builder-test-base:latest}

commands_pre =
    # Build collection tarball
    bash -c "cd {toxinidir} && ansible-galaxy collection build --force --output-path {envtmpdir}"

    # Create collection directory
    mkdir -p {env:HOME}/.ansible/collections

    # Install collection to default Ansible path (used by Molecule and sanity tests)
    bash -c "COLLECTION_TAR=$(ls -t {envtmpdir}/ansible-mcp_builder-*.tar.gz | head -1) && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path {env:HOME}/.ansible/collections"

    # Install dependencies (required for Molecule podman driver)
    ansible-galaxy collection install containers.podman ansible.posix --force --collections-path {env:HOME}/.ansible/collections

[testenv:sanity]
# Sanity tests run from the installed collection directory
commands =
    bash -c "cd {env:HOME}/.ansible/collections/ansible_collections/ansible/mcp_builder && ansible-test sanity --local --requirements --python {env:PYTHON_VERSION:3.10}"
