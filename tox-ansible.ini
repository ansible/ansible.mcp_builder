[ansible]
# Skip sanity tests that require the collection to be in a specific path structure
# We'll rely on the separate sanity job in the workflow instead
skip =
    sanity

[testenv]
# Use system site-packages to access molecule-plugins[podman] installed in container
sitepackages = True

deps =
    ansible-core>=2.14
    molecule-plugins[podman]

allowlist_externals =
    ansible-galaxy
    bash
    sh
    mkdir
    ls

# CRITICAL: Set ANSIBLE_COLLECTIONS_PATH so both Ansible and Molecule can find collections
# This must include:
# 1. {envtmpdir}/collections - where we install the collection for tests
# 2. {env:HOME}/.ansible/collections - default path where driver playbooks look
setenv =
    ANSIBLE_COLLECTIONS_PATH = {envtmpdir}/collections:{env:HOME}/.ansible/collections
    # Help Molecule find the image if set
    MOLECULE_IMAGE = {env:MOLECULE_IMAGE:ghcr.io/ansible/mcp-builder-test-base:latest}

# Build and install collection + dependencies to BOTH locations
# This ensures:
# - Test playbooks can find ansible.mcp_builder
# - Driver playbooks (create.yml) can find containers.podman
commands_pre =
    # 1. Build the collection tarball
    bash -c "cd {toxinidir} && ansible-galaxy collection build --force --output-path {envtmpdir}"

    # 2. Create collection directories
    mkdir -p {envtmpdir}/collections
    mkdir -p {env:HOME}/.ansible/collections

    # 3. Install OUR collection to tox environment
    bash -c "COLLECTION_TAR=$(ls -t {envtmpdir}/ansible-mcp_builder-*.tar.gz | head -1) && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path {envtmpdir}/collections"

    # 4. Install OUR collection to default Ansible path
    bash -c "COLLECTION_TAR=$(ls -t {envtmpdir}/ansible-mcp_builder-*.tar.gz | head -1) && ansible-galaxy collection install \"$COLLECTION_TAR\" --force --collections-path {env:HOME}/.ansible/collections"

    # 5. Install dependencies to tox environment (for test playbooks)
    ansible-galaxy collection install containers.podman ansible.posix --force --collections-path {envtmpdir}/collections

    # 6. Install dependencies to default path (CRITICAL for Molecule driver playbooks)
    ansible-galaxy collection install containers.podman ansible.posix --force --collections-path {env:HOME}/.ansible/collections

    # 7. Verify collections are accessible
    bash -c "ansible-galaxy collection list | grep -E '(mcp_builder|containers.podman|ansible.posix)' || echo 'Warning: Some collections may not be visible'"

# For sanity tests specifically (if we run them via tox)
# Note: Sanity tests are skipped in the main [testenv] section
# This section is kept for reference but won't be used since sanity is skipped
