---
  name: CI
  permissions:
    contents: read

  on:
    push:
      branches: [main, devel]
    pull_request:
      branches: [main, devel]

  jobs:
    ansible-lint:
      name: Ansible Lint
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: Install ansible-lint
          run: |
            pip install ansible-core ansible-lint

        - name: Run ansible-lint
          run: ansible-lint --profile production
          working-directory: ${{ github.workspace }}

    sanity-tests:
      name: Sanity Tests (Ansible ${{ matrix.ansible-version }})
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          ansible-version:
            - stable-2.14
            - stable-2.15
            - stable-2.16

      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            path: ansible_collections/ansible/mcp_builder

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: Install Ansible (${{ matrix.ansible-version }})
          run: |
            pip install https://github.com/ansible/ansible/archive/${{ matrix.ansible-version }}.tar.gz --disable-pip-version-check

        - name: Run sanity tests
          working-directory: ansible_collections/ansible/mcp_builder
          run: |
            ansible-test sanity --docker default -v --color

    integration-tests:
      name: Integration Tests
      runs-on: ubuntu-latest
      needs: [ansible-lint]

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: Install dependencies
          run: |
            pip install ansible-core molecule molecule-plugins[podman]
            sudo apt-get update
            sudo apt-get install -y podman

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Pull pre-built test image
          run: |
            podman pull ghcr.io/ansible/mcp-builder-test-base:latest

        - name: Start podman service
          run: |
            sudo systemctl start podman.socket
            sudo systemctl enable podman.socket
            sudo systemctl status podman.socket || true

        - name: Verify podman is working
          run: |
            podman info
            podman ps

        - name: Run Molecule integration tests
          run: |
            cd extensions
            molecule test -s integration --destroy=always
          env:
            ANSIBLE_FORCE_COLOR: '1'
            PY_COLORS: '1'
            MOLECULE_PROJECT_DIRECTORY: ${{ github.workspace }}/extensions

        - name: Upload test results
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: molecule-test-results
            path: |
              extensions/molecule/integration/*.log
              extensions/.molecule/

    test-summary:
      name: Test Summary
      runs-on: ubuntu-latest
      needs: [ansible-lint, sanity-tests, integration-tests]
      if: always()

      steps:
        - name: Check test results
          run: |
            echo "Ansible Lint: ${{ needs.ansible-lint.result }}"
            echo "Sanity Tests: ${{ needs.sanity-tests.result }}"
            echo "Integration Tests: ${{ needs.integration-tests.result }}"

            if [ "${{ needs.ansible-lint.result }}" != "success" ] || \
               [ "${{ needs.sanity-tests.result }}" != "success" ] || \
               [ "${{ needs.integration-tests.result }}" != "success" ]; then
              echo "Some tests failed"
              exit 1
            else
              echo "All tests passed!"
            fi
