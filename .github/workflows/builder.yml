---
  name: Build Test Base Image

  on:
    push:
      branches:
        - main
        - devel
      paths:
        - 'Containerfile'
        - 'bindep.txt'
        - '.github/workflows/builder.yml'
    pull_request:
      paths:
        - 'Containerfile'
    workflow_dispatch:
    schedule:
      # Rebuild weekly to get security updates
      - cron: '0 0 * * 0'

  permissions:
    contents: read
    packages: write

  jobs:
    build-and-push:
      name: Build and Push Test Base Image
      runs-on: ubuntu-latest

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log in to GitHub Container Registry
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Determine image tag
          id: tag
          run: |
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              # For PRs, push with PR-specific tag so integration tests can use it
              echo "image_tag=ghcr.io/${{ github.repository_owner }}/mcp-builder-test-base:pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
              echo "push_image=true" >> $GITHUB_OUTPUT
            elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
              echo "image_tag=ghcr.io/${{ github.repository_owner }}/mcp-builder-test-base:latest" >> $GITHUB_OUTPUT
              echo "push_image=true" >> $GITHUB_OUTPUT
            else
              BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///' | sed 's/\//-/g')
              echo "image_tag=ghcr.io/${{ github.repository_owner }}/mcp-builder-test-base:${BRANCH_NAME}" >> $GITHUB_OUTPUT
              echo "push_image=true" >> $GITHUB_OUTPUT
            fi

        - name: Build and push image
          uses: docker/build-push-action@v5
          with:
            context: .
            file: Containerfile
            push: ${{ steps.tag.outputs.push_image }}
            tags: ${{ steps.tag.outputs.image_tag }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
            labels: |
              org.opencontainers.image.source=${{ github.repositoryUrl }}
              org.opencontainers.image.revision=${{ github.sha }}

        - name: Test image
          if: steps.tag.outputs.push_image == 'true'
          run: |
            docker pull ${{ steps.tag.outputs.image_tag }}
            docker run --rm ${{ steps.tag.outputs.image_tag }} ansible --version
            docker run --rm ${{ steps.tag.outputs.image_tag }} python3 --version
            echo "Image built and tested successfully: ${{ steps.tag.outputs.image_tag }}"
