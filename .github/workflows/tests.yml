---
name: "CI"

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on: # yamllint disable-line rule:truthy
  pull_request:
    branches: [main]
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * *'

jobs:
  changelog:
    uses: ansible/ansible-content-actions/.github/workflows/changelog.yaml@main
    if: github.event_name == 'pull_request'
  build-import:
    uses: ansible/ansible-content-actions/.github/workflows/build_import.yaml@main
  ansible-lint:
    uses: ansible/ansible-content-actions/.github/workflows/ansible_lint.yaml@main
  sanity:
    uses: ansible/ansible-content-actions/.github/workflows/sanity.yaml@main
  unit-galaxy:
    uses: ansible/ansible-content-actions/.github/workflows/unit.yaml@main
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [ansible-lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ansible-core molecule molecule-plugins[podman]
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull pre-built test image
        run: |
          podman pull ghcr.io/ansible/mcp-builder-test-base:latest

      - name: Start podman service
        run: |
          sudo systemctl start podman.socket
          sudo systemctl enable podman.socket
          sudo systemctl status podman.socket || true

      - name: Verify podman is working
        run: |
          podman info
          podman ps

      - name: Run Molecule integration tests
        run: |
          cd extensions
          molecule test -s integration --destroy=always
        env:
          ANSIBLE_FORCE_COLOR: '1'
          PY_COLORS: '1'
          MOLECULE_PROJECT_DIRECTORY: ${{ github.workspace }}/extensions

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-test-results
          path: |
            extensions/molecule/integration/*.log
            extensions/.molecule/
  all_green:
    if: ${{ always() }}
    needs:
      - changelog
      - build-import
      - sanity
      - unit-galaxy
      - integration-tests
      - ansible-lint
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "Ansible Lint: ${{ needs.ansible-lint.result }}"
          echo "Sanity Tests: ${{ needs.sanity.result }}"
          echo "Unit Tests: ${{ needs.unit-galaxy.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Changelog: ${{ needs.changelog.result }}"
          echo "Build Import: ${{ needs.build-import.result }}"

          if [ "${{ needs.ansible-lint.result }}" != "success" ] || \
             [ "${{ needs.sanity.result }}" != "success" ] || \
             [ "${{ needs.unit-galaxy.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "Some tests failed"
            exit 1
          else
            echo "All tests passed!"
          fi
