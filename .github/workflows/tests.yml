---
  name: "CI"
  concurrency:
    group: ${{ github.head_ref || github.run_id }}
    cancel-in-progress: true
  on: # yamllint disable-line rule:truthy
    pull_request:
      branches: [main]
    workflow_dispatch:
    # schedule:
    #   - cron: '0 0 * * *'

  permissions:
    contents: read
    packages: write

  jobs:
    changelog:
      uses: ansible/ansible-content-actions/.github/workflows/changelog.yaml@main
      if: github.event_name == 'pull_request'

    build-import:
      uses: ansible/ansible-content-actions/.github/workflows/build_import.yaml@main

    ansible-lint:
      uses: ansible/ansible-content-actions/.github/workflows/ansible_lint.yaml@main

    sanity:
      uses: ansible/ansible-content-actions/.github/workflows/sanity.yaml@main

    unit-galaxy:
      uses: ansible/ansible-content-actions/.github/workflows/unit.yaml@main

    # NEW: Build or pull test image before integration tests
    build-test-image:
      name: Build Test Image
      runs-on: ubuntu-latest
      needs: [ansible-lint]
      permissions:
        contents: read
        packages: write
      outputs:
        image_tag: ${{ steps.determine.outputs.image_tag }}

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Determine if image exists and set tag
          id: determine
          run: |
            # Use PR-specific tag for PRs, latest for main branch
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/mcp-builder-test-base:pr-${{ github.event.pull_request.number }}"
            else
              IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/mcp-builder-test-base:latest"
            fi

            # Try to pull the image
            if docker pull "$IMAGE_TAG" 2>/dev/null; then
              echo "Image exists in registry: $IMAGE_TAG"
              echo "image_exists=true" >> $GITHUB_OUTPUT
            else
              echo "Image does not exist, will build it: $IMAGE_TAG"
              echo "image_exists=false" >> $GITHUB_OUTPUT
            fi

            echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

        - name: Set up Docker Buildx
          if: steps.determine.outputs.image_exists == 'false'
          uses: docker/setup-buildx-action@v3

        - name: Build and push image
          if: steps.determine.outputs.image_exists == 'false'
          uses: docker/build-push-action@v5
          with:
            context: .
            file: Containerfile
            push: true
            tags: ${{ steps.determine.outputs.image_tag }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
            labels: |
              org.opencontainers.image.source=${{ github.repositoryUrl }}
              org.opencontainers.image.revision=${{ github.sha }}

        - name: Verify image
          run: |
            docker pull ${{ steps.determine.outputs.image_tag }}
            docker run --rm ${{ steps.determine.outputs.image_tag }} ansible --version
            docker run --rm ${{ steps.determine.outputs.image_tag }} go version
            docker run --rm ${{ steps.determine.outputs.image_tag }} node --version

    integration-tests:
      name: Integration Tests
      runs-on: ubuntu-latest
      needs: [ansible-lint, build-test-image]  # Wait for image to be ready

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: Install dependencies
          run: |
            pip install ansible-core molecule molecule-plugins[podman]
            sudo apt-get update
            sudo apt-get install -y podman

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Pull pre-built test image
          run: |
            IMAGE_TAG="${{ needs.build-test-image.outputs.image_tag }}"
            echo "Pulling image: $IMAGE_TAG"
            podman pull "$IMAGE_TAG"

            # Verify image was pulled
            podman images | grep mcp-builder-test-base || (echo "Image not found after pull" && exit 1)

        - name: Start podman service (GitHub Actions compatible)
          run: |
            # Create runtime directory for podman rootless
            sudo mkdir -p /run/user/$(id -u)
            sudo chown -R $USER:$USER /run/user/$(id -u)

            # Start podman API service in background (no systemd required)
            podman system service -t 0 &
            
            sleep 3
            podman info

        - name: Verify podman is working
          run: |
            podman info
            podman ps
            # Ensure podman socket is accessible
            sudo chmod 666 /run/podman/podman.sock || true
            # Test podman can create a container
            podman run --rm --name test-container ghcr.io/ansible/mcp-builder-test-base:latest echo "Podman test" || true

        - name: Update molecule.yml with correct image tag
          run: |
            # Update molecule.yml to use the correct image tag (PR-specific or latest)
            cd extensions/molecule/integration
            IMAGE_TAG="${{ needs.build-test-image.outputs.image_tag }}"
            sed -i "s|image:.*|image: $IMAGE_TAG|" molecule.yml
            echo "Updated molecule.yml to use image: $IMAGE_TAG"
            cat molecule.yml | grep image:

        - name: Run Molecule integration tests
          run: |
            cd extensions
            # Verify molecule scenario exists
            if [ ! -f "molecule/integration/molecule.yml" ]; then
              echo "molecule.yml not found at molecule/integration/molecule.yml"
              ls -la molecule/ || echo "molecule/ directory not found"
              exit 1
            fi
            echo "Found molecule.yml at molecule/integration/molecule.yml"
            # Run molecule with explicit scenario name (using -s flag)
            # Note: Don't use --destroy=always since destroy is in test_sequence
            molecule test -s integration
          env:
            ANSIBLE_FORCE_COLOR: '1'
            PY_COLORS: '1'
            MOLECULE_PROJECT_DIRECTORY: ${{ github.workspace }}/extensions

        - name: Upload test results
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: molecule-test-results
            path: |
              extensions/molecule/integration/*.log
              extensions/.molecule/

    all_green:
      if: ${{ always() }}
      needs:
        - changelog
        - build-import
        - sanity
        - unit-galaxy
        - integration-tests
        - ansible-lint
      runs-on: ubuntu-latest
      steps:
        - name: Check test results
          run: |
            echo "Ansible Lint: ${{ needs.ansible-lint.result }}"
            echo "Sanity Tests: ${{ needs.sanity.result }}"
            echo "Unit Tests: ${{ needs.unit-galaxy.result }}"
            echo "Integration Tests: ${{ needs.integration-tests.result }}"
            echo "Changelog: ${{ needs.changelog.result }}"
            echo "Build Import: ${{ needs.build-import.result }}"

            # Don't fail on skipped changelog (only required for PRs)
            if [ "${{ needs.ansible-lint.result }}" != "success" ] || \
               [ "${{ needs.sanity.result }}" != "success" ] || \
               [ "${{ needs.unit-galaxy.result }}" != "success" ] || \
               [ "${{ needs.integration-tests.result }}" != "success" ]; then
              echo "Some tests failed"
              exit 1
            else
              echo "All tests passed!"
            fi
