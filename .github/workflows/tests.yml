---
name: "CI"
concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
on: # yamllint disable-line rule:truthy
  pull_request:
    branches: [main]
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * *'

permissions:
  contents: read
  packages: write

jobs:
  changelog:
    uses: ansible/ansible-content-actions/.github/workflows/changelog.yaml@main
    if: github.event_name == 'pull_request'

  build-import:
    uses: ansible/ansible-content-actions/.github/workflows/build_import.yaml@main

  ansible-lint:
    uses: ansible/ansible-content-actions/.github/workflows/ansible_lint.yaml@main

  sanity:
    uses: ansible/ansible-content-actions/.github/workflows/sanity.yaml@main

  unit-galaxy:
    uses: ansible/ansible-content-actions/.github/workflows/unit.yaml@main

  # NEW: Build or pull test image before integration tests
  build-test-image:
    name: Build Test Image
    runs-on: ubuntu-latest
    needs: [ansible-lint]
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.determine.outputs.image_tag }}

    steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Determine if image exists and set tag
          id: determine
          run: |
            # Use PR-specific tag for PRs, latest for main branch
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/mcp-builder-test-base:pr-${{ github.event.pull_request.number }}"
            else
              IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/mcp-builder-test-base:latest"
            fi

            # Try to pull the image
            if docker pull "$IMAGE_TAG" 2>/dev/null; then
              echo "Image exists in registry: $IMAGE_TAG"
              echo "image_exists=true" >> $GITHUB_OUTPUT
            else
              echo "Image does not exist, will build it: $IMAGE_TAG"
              echo "image_exists=false" >> $GITHUB_OUTPUT
            fi

            echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

        - name: Set up Docker Buildx
          if: steps.determine.outputs.image_exists == 'false'
          uses: docker/setup-buildx-action@v3

        - name: Build and push image
          if: steps.determine.outputs.image_exists == 'false'
          uses: docker/build-push-action@v5
          with:
            context: .
            file: Containerfile
            push: true
            tags: ${{ steps.determine.outputs.image_tag }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
            labels: |
              org.opencontainers.image.source=${{ github.repositoryUrl }}
              org.opencontainers.image.revision=${{ github.sha }}

        - name: Verify image
          run: |
            docker pull ${{ steps.determine.outputs.image_tag }}
            docker run --rm ${{ steps.determine.outputs.image_tag }} ansible --version
            docker run --rm ${{ steps.determine.outputs.image_tag }} go version
            docker run --rm ${{ steps.determine.outputs.image_tag }} node --version

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [ansible-lint, build-test-image]

    steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: Install Podman
          run: |
            sudo apt-get update
            sudo apt-get install -y podman uidmap

        - name: Setup Podman Rootless Environment
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            mkdir -p $XDG_RUNTIME_DIR
            sudo chown -R $USER:$USER $XDG_RUNTIME_DIR

        - name: Enable Podman Service (GitHub Actions compatible)
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            # Start podman API service in background (no systemd needed)
            nohup podman system service -t 0 > /tmp/podman-service.log 2>&1 &
            echo $! > /tmp/podman-service.pid
            sleep 5
            podman info
            echo "Podman service started, PID: $(cat /tmp/podman-service.pid)"

        - name: Install Molecule + Ansible deps
          run: |
            pip install ansible-core molecule molecule-plugins[podman]
            ansible-galaxy collection install containers.podman ansible.posix --force

        - name: Test Podman
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            podman info
            podman ps

        - name: Log in to GHCR for Podman
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            echo "${{ secrets.GITHUB_TOKEN }}" \
            | podman login ghcr.io --username ${{ github.actor }} --password-stdin

        - name: Pull pre-built test image
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            IMAGE_TAG="${{ needs.build-test-image.outputs.image_tag }}"
            echo "Pulling: $IMAGE_TAG"
            podman pull "$IMAGE_TAG"
            podman images | grep mcp-builder-test-base

        - name: Launch pre-built test container
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            IMAGE_TAG="${{ needs.build-test-image.outputs.image_tag }}"
            # Launch container and keep it running
            podman run -d \
              --name mcp-test-container \
              -v ${{ github.workspace }}:/workspace:rw \
              -w /workspace/extensions \
              -e MOLECULE_PROJECT_DIRECTORY=/workspace/extensions \
              "$IMAGE_TAG" \
              tail -f /dev/null
            echo "Container started: $(podman ps | grep mcp-test-container)"

        - name: Run Molecule integration tests inside container
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            # Run molecule inside the pre-launched container
            podman exec -w /workspace/extensions \
              -e ANSIBLE_FORCE_COLOR=1 \
              -e PY_COLORS=1 \
              -e MOLECULE_PROJECT_DIRECTORY=/workspace/extensions \
              mcp-test-container \
              molecule test -s integration

        - name: Cleanup test container
          if: always()
          run: |
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            podman rm -f mcp-test-container || true

        - name: Upload test results
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: molecule-test-results
            path: |
              extensions/molecule/integration/*.log
              extensions/.molecule/

  all_green:
    if: ${{ always() }}
    needs:
      - changelog
      - build-import
      - sanity
      - unit-galaxy
      - integration-tests
      - ansible-lint
    runs-on: ubuntu-latest
    steps:
        - name: Check test results
          run: |
            echo "Ansible Lint: ${{ needs.ansible-lint.result }}"
            echo "Sanity Tests: ${{ needs.sanity.result }}"
            echo "Unit Tests: ${{ needs.unit-galaxy.result }}"
            echo "Integration Tests: ${{ needs.integration-tests.result }}"
            echo "Changelog: ${{ needs.changelog.result }}"
            echo "Build Import: ${{ needs.build-import.result }}"

            # Don't fail on skipped changelog (only required for PRs)
            if [ "${{ needs.ansible-lint.result }}" != "success" ] || \
               [ "${{ needs.sanity.result }}" != "success" ] || \
               [ "${{ needs.unit-galaxy.result }}" != "success" ] || \
               [ "${{ needs.integration-tests.result }}" != "success" ]; then
              echo "Some tests failed"
              exit 1
            else
              echo "All tests passed!"
            fi
